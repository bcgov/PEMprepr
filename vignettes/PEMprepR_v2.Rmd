---
title: "Introduction to PEMprepr"
subtitle: "[placeholder]"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to PEMprepr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

require(PEMprepr)
require(ggplot2)
require(sf)
require(terra)
require(tidyverse)
require(bcdata)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`PEMprepr`, short for *Predictive Ecosystem Mapping -- Preparation*, is the first of four packages supporting BC's Predictive Ecosystem Mapping (PEM) Methods Project. For detailed information on the PEM Methods Project, including research background, data usage, methodology, and outcomes, please refer to the PEM Manual and the `PEMr` meta-package documentation.

`PEMprepr` is used to prepare all of the input data for the sampling and modelling processes. This includes setting up the folder structure, downloading base layers such as forest classification and road access, and producing covariates for the area of interest. This vignette will walk you through the key steps of the preparation process and provide guidance and example outputs for the major functions.

Once you are familiar with the mechanics of the `PEMprepr` workflow, you can download and fill in the provided pipeline script to prepare your own PEM area of interest.

The key steps demonstrated below include:

(1) Data folder set up

(2) Alignment of the area of interest

(3) Collection of base layer vector data

(5) Download and processing of lidar data

(6) Generation of covariates

(7) Packaging input data for subsequent use

A portion of the [Aleza Lake Research Forest](www.aleza.unbc.ca), one of the pilot study sites for this project, is used throughout this vignette. The area outlined in coral will be used in the steps below.


![Aleza Lake Research Forest with northwest quadrant outlined.](aleza.png)


###  Folder Setup

The data layers and standards required to execute PEM can quickly become difficult to manage. To facilitate ease of data management, a standard set of folders should be generated for each area of interest. The following function creates the needed folders for the area of interest: *aleza*. In addition, the named variable `fstr` stores a named list of the full and relative paths which we will utilize later to programmatically place results of functions in the correct place.

\_Note: if the folders have been generated previously this function will
still return the list of folder names.


```{r, results='hold'}

fstr <- setup_folders("vignettes/aleza")

fstr[1:5]

```

The printed output shows the first five list items with relative `[1]` and full `[2]` directory paths stored.


### Alignment of the area of interest

One concern, with this *area-of-interest* (`aoi`) (red area) is that the
bounding box or geographic extent of the area ends with very random
numbers (output above). Using this extent will cause significant
problems later when we attempt to stack numerous rasters.

#### Snap the extent

Here the `aoi` is snapped to an extent divisible by 100. This will
facilitate the generation of rasters data that all fits this grid extent
and thereby can be stacked with relative ease.

```{r}
aoi <- sf::st_read(system.file("extdata/aleza_nw.gpkg", 
                                 package = "PEMprepr"), quiet = TRUE)

aoi_snap(aoi, method = "shrink") ## or expand
```
